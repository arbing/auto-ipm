# IP白名单自动更新工具

自动获取本机公网IP并更新腾讯云安全组参数模板的工具。

## 功能

- 获取当前公网IP（国内服务 cip.cc + ip.cn）
- 查询/更新腾讯云安全组参数模板指定描述的成员IP
- 支持飞书群消息通知
- 编译为独立可执行文件，加载`.env`环境变量，直接运行
- 支持定时任务管理，通过命令行安装/卸载/查看定时任务
- 支持日志记录，分为标准输出日志和错误日志

## 快速开始

```bash
# 安装依赖
bun install

# 配置环境变量
cp .env.example .env
# 编辑 .env 文件填入配置

# 手动运行测试
bun run src/main.ts

# 编译为可执行文件
bun build src/main.ts --compile --outfile=dist/auto-ipm

# 运行可执行文件
cd dist
./auto-ipm
```

## 环境变量

### 必需配置

```env
# 腾讯云配置
TENCENT_CLOUD_SECRET_ID=your_secret_id_here
TENCENT_CLOUD_SECRET_KEY=your_secret_key_here
TENCENT_CLOUD_REGION=ap-beijing

# 地址模板配置
ADDRESS_TEMPLATE_ID=ipm-xxxxxxxx
ADDRESS_TEMPLATE_MEMBER_DESCRIPTION=成员描述标识

# 飞书 webhook URL (可选，用于通知)
FEISHU_WEBHOOK_URL=https://open.feishu.cn/open-apis/bot/v2/hook/your-webhook-id
```

### 配置说明

1. **腾讯云 Secret ID/Key**:
   - 从腾讯云控制台获取
   - 需要具有 VPC 相关权限（修改地址模板）

2. **Region**:
   - 默认为 `ap-beijing`（北京区域）
   - 可根据实际需求修改为其他区域

3. **地址模板 ID**:
   - 格式为 `ipm-xxxxxxxx`
   - 在腾讯云控制台的【网络与安全】->【安全组】->【参数模板】中获取

4. **成员描述**:
   - 用于标识要更新的 IP 成员
   - 必须与腾讯云地址模板中的成员描述完全匹配

5. **飞书 Webhook URL**:
   - 可选配置，用于发送执行结果通知
   - 在飞书群中创建机器人获取 Webhook URL

## 定时任务管理

本工具支持通过命令行管理定时任务，方便自动化IP更新。

### Cron 表达式格式

Cron 表达式由5个字段组成，格式为：`分钟 小时 日 月 星期`

- **分钟 (0-59)**: 执行的分钟
- **小时 (0-23)**: 执行的小时（24小时制）
- **日 (1-31)**: 执行的日期
- **月 (1-12)**: 执行的月份
- **星期 (0-7)**: 执行的星期（0和7都表示周日）

常用示例：

- `30 9 * * *` - 每天上午9:30执行
- `0 0 * * *` - 每天午夜0:00执行
- `0 0 * * 0` - 每周日午夜0:00执行
- `0 0 1 * *` - 每月1号午夜0:00执行

### 命令说明

```bash
# 直接运行（手动执行IP更新）
./auto-ipm

# 安装定时任务（例如每天9点30执行一次）
./auto-ipm cron add "30 9 * * *"

# 卸载所有 auto-ipm 相关的定时任务
./auto-ipm cron remove

# 查看已安装的定时任务
./auto-ipm cron list
```

### 使用注意事项

1. **工作目录**: 定时任务会自动设置工作目录为可执行文件所在目录，确保 `.env` 文件能被正确加载
2. **重复检测**: 系统会自动检测并避免重复安装相同的定时任务
3. **权限要求**: 需要当前用户有 crontab 权限才能管理定时任务
4. **日志记录**: 定时任务执行的日志会记录到 `logs/info.log` 和 `logs/error.log` 文件中
5. **环境变量**: 确保 `.env` 文件位于可执行文件同目录下，包含所有必要的配置

## 日志

- `logs/info.log` - 标准输出
- `logs/error.log` - 错误日志

## 故障排查与注意事项

### 常见问题

1. **"缺少必要的配置字段" 错误**
   - 确保 `.env` 文件包含所有必需的环境变量
   - 检查变量名是否正确（区分大小写）
   - 确保 `.env` 文件位于可执行文件同目录下

2. **腾讯云 API 调用失败**
   - 验证 Secret ID/Key 是否正确
   - 确认账号具有 VPC 相关权限
   - 检查 Region 配置是否正确
   - 确认地址模板 ID 和成员描述是否准确

3. **公网 IP 获取失败**
   - 检查网络连接
   - 工具会自动尝试多个服务（cip.cc 和 ip.cn）
   - 如果都失败，可能需要检查防火墙设置

4. **定时任务不执行**
   - 确认 crontab 服务正在运行
   - 检查 `crontab -l` 确认定时任务已正确安装
   - 查看系统日志 `/var/log/cron` 或类似位置
   - 确保可执行文件路径正确且有执行权限

### 最佳实践

1. **安全考虑**
   - 不要在版本控制系统中提交 `.env` 文件
   - 定期轮换腾讯云 Secret Key
   - 为工具创建专用的腾讯云子账号，限制最小必要权限

2. **监控建议**
   - 启用飞书通知以便及时了解执行状态
   - 定期检查日志文件
   - 考虑设置更频繁的定时任务（如每小时）以确保IP及时更新

3. **备份策略**
   - 在生产环境中使用前，先在测试环境验证
   - 保留手动更新 IP 的能力作为备用方案
